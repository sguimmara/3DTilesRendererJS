import{Q as O,l as f,ad as A,i as c,k as U,V as N}from"./three.module-e-akeimH.js";import{E as Z,c as P,N as H,s as w,m as R,D as j,a as L,b as q,Z as k}from"./EnvironmentControls-BRJ_vGuv.js";import{E as Q}from"./Ellipsoid-Ctcbk2JV.js";const S=new U,W=new U,g=new f,s=new f,_=new f,p=new f,F=new f,v=new f,V=new f,x=new O,E=new f,y=new f,a=new A,I=new Q,G={},b=new N,B=400;class $ extends Z{get ellipsoid(){return this.tilesRenderer?this.tilesRenderer.ellipsoid:null}get tilesGroup(){return this.tilesRenderer?this.tilesRenderer.group:null}constructor(t=null,i=null,o=null,r=null){super(t,i,o),this.isGlobeControls=!0,this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.nearMargin=.25,this.farMargin=0,this.useFallbackPlane=!1,this.reorientOnDrag=!1,this.globeInertia=new O,this.globeInertiaFactor=0,this.setTilesRenderer(r)}setScene(t){t===null&&this.tilesRenderer!==null?super.setScene(this.tilesRenderer.group):super.setScene(t)}getPivotPoint(t){const{camera:i,tilesGroup:o,ellipsoid:r}=this;return p.set(0,0,-1).transformDirection(i.matrixWorld),a.origin.copy(i.position),a.direction.copy(p),a.applyMatrix4(o.matrixWorldInverse),P(a,r,s),s.applyMatrix4(o.matrixWorld),(super.getPivotPoint(t)===null||t.distanceTo(a.origin)>s.distanceTo(a.origin))&&t.copy(s),t}getVectorToCenter(t){const{tilesGroup:i,camera:o}=this;return t.setFromMatrixPosition(i.matrixWorld).sub(o.position)}getDistanceToCenter(){return this.getVectorToCenter(s).length()}getUpDirection(t,i){const{tilesGroup:o,ellipsoid:r}=this;s.copy(t).applyMatrix4(o.matrixWorldInverse),r.getPositionToNormal(s,i),i.transformDirection(o.matrixWorld)}getCameraUpDirection(t){const{tilesGroup:i,ellipsoid:o,camera:r}=this;r.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(s),s.applyMatrix4(i.matrixWorldInverse),o.getPositionToNormal(s,t),t.transformDirection(i.matrixWorld)):this.getUpDirection(r.position,t)}update(t=Math.min(this.clock.getDelta(),64/1e3)){if(!this.enabled||!this.tilesGroup||!this.camera||t===0)return;const{camera:i,pivotMesh:o}=this;this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(this.state!==H&&this._dragMode!==1&&this._rotationMode!==1&&(o.visible=!1),this.scaleZoomOrientationAtEdges=!1),super.update(t),this.adjustCamera(i)}adjustCamera(t){super.adjustCamera(t);const{tilesGroup:i,ellipsoid:o,nearMargin:r,farMargin:e}=this,l=Math.max(...o.radius);if(t.isPerspectiveCamera){const n=s.setFromMatrixPosition(i.matrixWorld).sub(t.position).length(),h=r*l,m=c.clamp((n-l)/h,0,1),d=c.lerp(1,1e3,m);t.near=Math.max(d,n-l-h),g.copy(t.position).applyMatrix4(i.matrixWorldInverse),o.getPositionToCartographic(g,G);const u=Math.max(o.getPositionElevation(g),B),M=o.calculateHorizonDistance(G.lat,u);t.far=M*2.5+.1+l*e,t.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(t.position,t),t.updateMatrixWorld(),S.copy(t.matrixWorld).invert(),s.setFromMatrixPosition(i.matrixWorld).applyMatrix4(S);const n=-s.z;t.near=n-l*(1+r),t.far=n+.1+l*e,t.position.addScaledVector(p,t.near),t.far-=t.near,t.near=0,t.updateProjectionMatrix(),t.updateMatrixWorld()}}resetState(){super.resetState(),this._dragMode=0,this._rotationMode=0}_updateInertia(t){super._updateInertia(t);const{globeInertia:i,enableDamping:o,dampingFactor:r,camera:e,cameraRadius:l,minDistance:n,inertiaTargetDistance:h,tilesGroup:m}=this;if(!this.enableDamping||this.inertiaStableFrames>1){this.globeInertiaFactor=0,this.globeInertia.identity();return}const d=Math.pow(2,-t/r),u=Math.max(e.near,l,n,h),C=.25*(2/(2*1e3));if(_.setFromMatrixPosition(m.matrixWorld),this.globeInertiaFactor!==0){w(a,s.set(0,0,-1),e),a.applyMatrix4(e.matrixWorldInverse),a.direction.normalize(),a.recast(-a.direction.dot(a.origin)).at(u/a.direction.z,s),s.applyMatrix4(e.matrixWorld),w(a,g.set(C,C,-1),e),a.applyMatrix4(e.matrixWorldInverse),a.direction.normalize(),a.recast(-a.direction.dot(a.origin)).at(u/a.direction.z,g),g.applyMatrix4(e.matrixWorld),s.sub(_).normalize(),g.sub(_).normalize(),this.globeInertiaFactor*=d;const z=s.angleTo(g)/t;(2*Math.acos(i.w)*this.globeInertiaFactor<z||!o)&&(this.globeInertiaFactor=0,i.identity())}this.globeInertiaFactor!==0&&(i.w===1&&(i.x!==0||i.y!==0||i.z!==0)&&(i.w=Math.min(i.w,1-1e-9)),_.setFromMatrixPosition(m.matrixWorld),x.identity().slerp(i,this.globeInertiaFactor*t),R(_,x,W),e.matrixWorld.premultiply(W),e.matrixWorld.decompose(e.position,e.quaternion,s))}_inertiaNeedsUpdate(){return super._inertiaNeedsUpdate()||this.globeInertiaFactor!==0}_updatePosition(t){if(this.state===j){this._dragMode===0&&(this._dragMode=this._isNearControls()?1:-1);const{raycaster:i,camera:o,pivotPoint:r,pointerTracker:e,domElement:l,tilesGroup:n}=this,h=g,m=v;e.getCenterPoint(b),L(b.x,b.y,l,b),w(i,b,o),i.ray.applyMatrix4(n.matrixWorldInverse);const d=s.copy(r).applyMatrix4(n.matrixWorldInverse).length();I.radius.setScalar(d),o.isPerspectiveCamera?I.intersectRay(i.ray,s)||q(i.ray,d,s):P(i.ray,I,s),s.applyMatrix4(n.matrixWorld),_.setFromMatrixPosition(n.matrixWorld),h.subVectors(r,_).normalize(),m.subVectors(s,_).normalize(),x.setFromUnitVectors(m,h),R(_,x,W),o.matrixWorld.premultiply(W),o.matrixWorld.decompose(o.position,o.quaternion,s),e.getMoveDistance()/t<2*window.devicePixelRatio?this.inertiaStableFrames++:(this.globeInertia.copy(x),this.globeInertiaFactor=1/t,this.inertiaStableFrames=0)}this._alignCameraUp(this.up)}_updateRotation(...t){this._rotationMode===1||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...t)):(this.pivotMesh.visible=!1,this._rotationMode=-1),this._alignCameraUp(this.up)}_updateZoom(){const{zoomDelta:t,ellipsoid:i,zoomSpeed:o,zoomPoint:r,camera:e,maxZoom:l,state:n}=this;if(n!==k&&t===0)return;this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),this.globeInertia.identity(),this.globeInertiaFactor=0;const h=c.clamp(c.mapLinear(Math.abs(t),0,20,0,1),0,1);if(this._isNearControls()||t>0){if(this._updateZoomDirection(),t<0&&(this.zoomPointSet||this._updateZoomPoint())){p.set(0,0,-1).transformDirection(e.matrixWorld).normalize(),y.copy(this.up).multiplyScalar(-1),this.getUpDirection(r,E);const m=c.clamp(c.mapLinear(-E.dot(y),1,.95,0,1),0,1),d=1-p.dot(y),u=e.isOrthographicCamera?.05:1,M=c.clamp(h*3,0,1),D=Math.min(m*d*u*M,.1);y.lerpVectors(p,y,D).normalize(),x.setFromUnitVectors(p,y),R(r,x,W),e.matrixWorld.premultiply(W),e.matrixWorld.decompose(e.position,e.quaternion,y),this.zoomDirection.subVectors(r,e.position).normalize()}super._updateZoom()}else if(e.isPerspectiveCamera){const m=this._getPerspectiveTransitionDistance(),d=this._getMaxPerspectiveDistance(),u=c.mapLinear(this.getDistanceToCenter(),m,d,0,1);this._tiltTowardsCenter(c.lerp(0,.4,u*h)),this._alignCameraUpToNorth(c.lerp(0,.2,u*h));const M=this.getDistanceToCenter()-i.radius.x,D=t*M*o*.0025,C=Math.max(D,Math.min(this.getDistanceToCenter()-d,0));this.getVectorToCenter(s).normalize(),this.camera.position.addScaledVector(s,C),this.camera.updateMatrixWorld(),this.zoomDelta=0}else{const m=this._getOrthographicTransitionZoom(),d=this._getMinOrthographicZoom(),u=c.mapLinear(e.zoom,m,d,0,1);this._tiltTowardsCenter(c.lerp(0,.4,u*h)),this._alignCameraUpToNorth(c.lerp(0,.2,u*h));const M=this.zoomDelta,D=Math.pow(.95,Math.abs(M*.05)),C=M>0?1/Math.abs(D):D,z=d/e.zoom,T=Math.max(C*o,Math.min(z,1));e.zoom=Math.min(l,e.zoom*T),e.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(t){const{tilesGroup:i}=this;V.set(0,0,1).transformDirection(i.matrixWorld),this._alignCameraUp(V,t)}_alignCameraUp(t,i=null){const{camera:o}=this;p.set(0,0,-1).transformDirection(o.matrixWorld),F.set(-1,0,0).transformDirection(o.matrixWorld),v.crossVectors(t,p),i===null&&(i=1-Math.abs(p.dot(t)),i=c.mapLinear(i,0,1,-.01,1),i=c.clamp(i,0,1)**2),v.lerp(F,1-i).normalize(),x.setFromUnitVectors(F,v),o.quaternion.premultiply(x),o.updateMatrixWorld()}_tiltTowardsCenter(t){const{camera:i,tilesGroup:o}=this;p.set(0,0,-1).transformDirection(i.matrixWorld).normalize(),s.setFromMatrixPosition(o.matrixWorld).sub(i.position).normalize(),s.lerp(p,1-t).normalize(),x.setFromUnitVectors(p,s),i.quaternion.premultiply(x),i.updateMatrixWorld()}_getPerspectiveTransitionDistance(){const{camera:t,ellipsoid:i}=this;if(!t.isPerspectiveCamera)throw new Error;const o=Math.max(...i.radius),r=2*Math.atan(Math.tan(c.DEG2RAD*t.fov*.5)*t.aspect),e=o/Math.tan(c.DEG2RAD*t.fov*.5),l=o/Math.tan(r*.5);return Math.max(e,l)}_getMaxPerspectiveDistance(){const{camera:t,ellipsoid:i}=this;if(!t.isPerspectiveCamera)throw new Error;const o=Math.max(...i.radius),r=2*Math.atan(Math.tan(c.DEG2RAD*t.fov*.5)*t.aspect),e=o/Math.tan(c.DEG2RAD*t.fov*.5),l=o/Math.tan(r*.5);return 2*Math.max(e,l)}_getOrthographicTransitionZoom(){const{camera:t,ellipsoid:i}=this;if(!t.isOrthographicCamera)throw new Error;const o=t.top-t.bottom,r=t.right-t.left,e=Math.max(o,r),n=2*Math.max(...i.radius);return 2*e/n}_getMinOrthographicZoom(){const{camera:t,ellipsoid:i}=this;if(!t.isOrthographicCamera)throw new Error;const o=t.top-t.bottom,r=t.right-t.left,e=Math.min(o,r),n=2*Math.max(...i.radius);return .7*e/n}_getVirtualOrthoCameraPosition(t,i=this.camera){const{tilesGroup:o,ellipsoid:r}=this;if(!i.isOrthographicCamera)throw new Error;a.origin.copy(i.position),a.direction.set(0,0,-1).transformDirection(i.matrixWorld),a.applyMatrix4(o.matrixWorldInverse),P(a,r,g),g.applyMatrix4(o.matrixWorld);const e=i.top-i.bottom,l=i.right-i.left,n=Math.max(e,l)/i.zoom;p.set(0,0,-1).transformDirection(i.matrixWorld);const h=g.sub(i.position).dot(p);t.copy(i.position).addScaledVector(p,h-n*4)}_isNearControls(){const{camera:t}=this;return t.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():t.zoom>this._getOrthographicTransitionZoom()}_raycast(t){const i=super._raycast(t);if(i===null){const{ellipsoid:o,tilesGroup:r}=this;a.copy(t.ray).applyMatrix4(r.matrixWorldInverse);const e=o.intersectRay(a,s);return e!==null?{point:e.clone().applyMatrix4(r.matrixWorld)}:null}else return i}}export{$ as G};
