import{L as m,r as G,F as x,B as R}from"./readMagicBytes-CUUeQGnc.js";import{l as g,V as M,i as P,bq as V,aj as F,al as v,am as y,C as H,bG as Q}from"./three.module-e-akeimH.js";class Y extends m{parse(c){const e=new DataView(c),t=G(e);console.assert(t==="pnts");const L=e.getUint32(4,!0);console.assert(L===1);const n=e.getUint32(8,!0);console.assert(n===c.byteLength);const T=e.getUint32(12,!0),b=e.getUint32(16,!0),s=e.getUint32(20,!0),p=e.getUint32(24,!0),N=28,o=c.slice(N,N+T+b),A=new x(o,0,T,b),u=N+T+b,E=c.slice(u,u+s+p),O=new R(E,A.getData("BATCH_LENGTH")||A.getData("POINTS_LENGTH"),0,s,p);return Promise.resolve({version:L,featureTable:A,batchTable:O})}}function Z(d){const c=d>>11,e=d>>5&63,t=d&31,L=Math.round(c/31*255),n=Math.round(e/63*255),T=Math.round(t/31*255);return[L,n,T]}const S=new M;function z(d,c,e=new g){S.set(d,c).divideScalar(256).multiplyScalar(2).subScalar(1),e.set(S.x,S.y,1-Math.abs(S.x)-Math.abs(S.y));const t=P.clamp(-e.z,0,1);return e.x>=0?e.setX(e.x-t):e.setX(e.x+t),e.y>=0?e.setY(e.y-t):e.setY(e.y+t),e.normalize(),e}const U={RGB:"color",POSITION:"position"};class q extends Y{constructor(c=V){super(),this.manager=c}parse(c){return super.parse(c).then(async e=>{const{featureTable:t,batchTable:L}=e,n=new F,T=t.header.extensions,b=new g;let s;if(T&&T["3DTILES_draco_point_compression"]){const{byteOffset:o,byteLength:A,properties:u}=T["3DTILES_draco_point_compression"],E=this.manager.getHandler("draco.drc");if(E==null)throw new Error("PNTSLoader: dracoLoader not available.");const O={};for(const l in u)if(l in U&&l in u){const B=U[l];O[B]=u[l]}const D={attributeIDs:O,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},_=t.getBuffer(o,A);s=await E.decodeGeometry(_,D),s.attributes.color&&(n.vertexColors=!0)}else{const o=t.getData("POINTS_LENGTH"),A=t.getData("POSITION",o,"FLOAT","VEC3"),u=t.getData("NORMAL",o,"FLOAT","VEC3"),E=t.getData("NORMAL",o,"UNSIGNED_BYTE","VEC2"),O=t.getData("RGB",o,"UNSIGNED_BYTE","VEC3"),D=t.getData("RGBA",o,"UNSIGNED_BYTE","VEC4"),_=t.getData("RGB565",o,"UNSIGNED_SHORT","SCALAR"),l=t.getData("CONSTANT_RGBA",o,"UNSIGNED_BYTE","VEC4"),B=t.getData("POSITION_QUANTIZED",o,"UNSIGNED_SHORT","VEC3"),w=t.getData("QUANTIZED_VOLUME_SCALE",o,"FLOAT","VEC3"),I=t.getData("QUANTIZED_VOLUME_OFFSET",o,"FLOAT","VEC3");if(s=new v,B){const i=new Float32Array(o*3);for(let r=0;r<o;r++)for(let a=0;a<3;a++){const f=3*r+a;i[f]=B[f]/65535*w[a]}b.x=I[0],b.y=I[1],b.z=I[2],s.setAttribute("position",new y(i,3,!1))}else s.setAttribute("position",new y(A,3,!1));if(u!==null)s.setAttribute("normal",new y(u,3,!1));else if(E!==null){const i=new Float32Array(o*3),r=new g;for(let a=0;a<o;a++){const f=E[a*2],h=E[a*2+1],C=z(f,h,r);i[a*3]=C.x,i[a*3+1]=C.y,i[a*3+2]=C.z}s.setAttribute("normal",new y(i,3,!1))}if(D!==null)s.setAttribute("color",new y(D,4,!0)),n.vertexColors=!0,n.transparent=!0,n.depthWrite=!1;else if(O!==null)s.setAttribute("color",new y(O,3,!0)),n.vertexColors=!0;else if(_!==null){const i=new Uint8Array(o*3);for(let r=0;r<o;r++){const a=Z(_[r]);for(let f=0;f<3;f++){const h=3*r+f;i[h]=a[f]}}s.setAttribute("color",new y(i,3,!0)),n.vertexColors=!0}else if(l!==null){const i=new H(l[0],l[1],l[2]);n.color=i;const r=l[3]/255;r<1&&(n.opacity=r,n.transparent=!0,n.depthWrite=!1)}}const p=new Q(s,n);p.position.copy(b),e.scene=p,e.scene.featureTable=t,e.scene.batchTable=L;const N=t.getData("RTC_CENTER");return N&&(e.scene.position.x+=N[0],e.scene.position.y+=N[1],e.scene.position.z+=N[2]),e})}}export{q as P};
