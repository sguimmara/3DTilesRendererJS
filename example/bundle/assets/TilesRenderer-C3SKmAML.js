import{F as B,L as I,U as k,a as O,P as H,W as Ee,I as Ae}from"./I3DMLoader-BvoAYWAX.js";import{B as Be}from"./B3DMLoader-BmDNS6RO.js";import{P as Ve}from"./PNTSLoader-DzQ3_PKf.js";import{C as De}from"./CMPTLoader-Bq-8QR4v.js";import{G as pe,k as L,ad as me,l as x,B as Ie,au as Oe,d as Ne,bo as ze,b5 as We,bn as qe,aK as je,aI as N,V as _e,bp as Ge}from"./three.module-e-akeimH.js";import{r as Je}from"./readMagicBytes-CUUeQGnc.js";import{E as Qe}from"./EllipsoidRegion-DVvlgLqj.js";import{e as $e,G as He}from"./GLTFLoader-uVyzW9cX.js";function re(i){if(!i)return null;const e=i.replace(/[a-z]+:\/\/[^/]+/i,"").replace(/\?.*$/i,"").replace(/.*\//g,""),t=e.lastIndexOf(".");return t===-1?null:e.substring(t+1)||null}const oe=2**30;class Ye{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),o=e(s);return n<o?-1:n>o?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=.3*oe,this.maxBytesSize=.4*oe,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)??null}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,o=this.itemList,r=this.callbacks,a=this.bytesMap;o.push(e),n.add(e),s.set(e,Date.now()),r.set(e,t);const l=this.computeMemoryUsageCallback(e);return this.cachedBytes+=l||0,a.set(e,l),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,o=this.bytesMap,r=this.callbacks,a=this.loadedSet;if(s.has(e)){this.cachedBytes-=o.get(e)||0,o.delete(e),r.get(e)(e);const l=n.indexOf(e);return n.splice(l,1),t.delete(e),s.delete(e),r.delete(e),a.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(t===!0?n.add(e):n.delete(e))}updateMemoryUsage(e){const t=this.itemSet,s=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=s.get(e)||0;const n=this.computeMemoryUsageCallback(e);s.set(e,n),this.cachedBytes+=n}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:o,usedSet:r,loadedSet:a,callbacks:l,bytesMap:c,minBytesSize:d,maxBytesSize:p}=this,h=n.length-r.size,f=n.length-a.size,_=Math.max(Math.min(n.length-t,h),0),b=this.cachedBytes-d,m=this.unloadPriorityCallback||this.defaultPriorityCallback;let T=!1;const F=_>0&&h>0||f&&n.length>s;if(h&&this.cachedBytes>d||f&&this.cachedBytes>p||F){n.sort((y,C)=>{const ne=r.has(y),Fe=r.has(C);if(ne===Fe){const ie=a.has(y),Ue=a.has(C);return ie===Ue?-m(y,C):ie?1:-1}else return ne?1:-1});const A=Math.max(t*e,_*e),u=Math.ceil(Math.min(A,h,_)),v=Math.max(e*b,e*d),w=Math.min(v,b);let g=0,E=0;for(;this.cachedBytes-E>p||n.length-g>s;){const y=n[g],C=c.get(y)||0;if(r.has(y)&&a.has(y)||this.cachedBytes-E-C<p&&n.length-g<=s)break;E+=C,g++}for(;E<w||g<u;){const y=n[g],C=c.get(y)||0;if(r.has(y)||this.cachedBytes-E-C<d&&g>=u)break;E+=C,g++}n.splice(0,g).forEach(y=>{this.cachedBytes-=c.get(y)||0,l.get(y)(y),c.delete(y),o.delete(y),l.delete(y),a.delete(y),r.delete(y)}),T=g<_||E<b&&g<h,T=T&&g>0}T&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent()}))}}class Y{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const e=this.priorityCallback;this.items.sort(e)}has(e){return this.callbacks.has(e)}add(e,t){return new Promise((s,n)=>{const o=this.items,r=this.callbacks;o.push(e),r.set(e,{callback:t,resolve:s,reject:n}),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=0;const o=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;s>this.currJobs&&e.length>0&&n<s;){this.currJobs++,n++;const r=e.pop(),{callback:a,resolve:l,reject:c}=t.get(r);t.delete(r);let d;try{d=a(r)}catch(p){c(p),o()}d instanceof Promise?d.then(l).catch(c).finally(o):(l(d),o())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const z={inView:!1,error:1/0,distance:1/0};function ge(i){return i===I||i===B}function U(i,e){return i.__lastFrameVisited===e&&i.__used}function te(i){return i.__childrenProcessed===i.children.length}function se(i,e){i.__lastFrameVisited!==e.frameCount&&(i.__lastFrameVisited=e.frameCount,i.__used=!1,i.__inFrustum=!1,i.__isLeaf=!1,i.__visible=!1,i.__active=!1,i.__error=1/0,i.__distanceFromCamera=1/0,i.__childrenWereVisible=!1,i.__allChildrenLoaded=!1,e.calculateTileViewError(i,z),i.__inFrustum=z.inView,i.__error=z.error,i.__distanceFromCamera=z.distance)}function be(i,e){if(e.ensureChildrenArePreprocessed(i),se(i,e),ee(i,e),!i.__hasRenderableContent&&te(i)){const t=i.children;for(let s=0,n=t.length;s<n;s++)be(t[s],e)}}function ye(i,e){if(e.ensureChildrenArePreprocessed(i),U(i,e.frameCount)&&(i.__hasContent&&i.__loadingState===k&&!e.lruCache.isFull()&&e.queueTileForDownload(i),te(i))){const t=i.children;for(let s=0,n=t.length;s<n;s++)ye(t[s],e)}}function ee(i,e){i.__used||(i.__used=!0,e.markTileUsed(i),e.stats.used++,i.__inFrustum===!0&&e.stats.inFrustum++)}function Xe(i,e){return!(i.__error<=e.errorTarget||e.maxDepth>0&&i.__depth+1>=e.maxDepth||!te(i))}function Ze(i,e=null,t=null){const s=[];for(s.push(i),s.push(null),s.push(0);s.length>0;){const n=s.pop(),o=s.pop(),r=s.pop();if(e&&e(r,o,n)){t&&t(r,o,n);return}const a=r.children;if(a)for(let l=a.length-1;l>=0;l--)s.push(a[l]),s.push(r),s.push(n+1);t&&t(r,o,n)}}function xe(i,e){if(e.ensureChildrenArePreprocessed(i),se(i,e),!i.__inFrustum)return;if(!Xe(i,e)){ee(i,e);return}let t=!1,s=!1;const n=i.children;for(let o=0,r=n.length;o<r;o++){const a=n[o];xe(a,e),t=t||U(a,e.frameCount),s=s||a.__inFrustum}if(i.refine==="REPLACE"&&!s&&n.length!==0&&!i.__hasUnrenderableContent){i.__inFrustum=!1;return}if(ee(i,e),t&&i.refine==="REPLACE")for(let o=0,r=n.length;o<r;o++){const a=n[o];be(a,e)}}function Se(i,e){const t=e.frameCount;if(!U(i,t))return;const s=i.children;let n=!1;for(let o=0,r=s.length;o<r;o++){const a=s[o];n=n||U(a,t)}if(!n)i.__isLeaf=!0;else{let o=!1,r=!0;for(let a=0,l=s.length;a<l;a++){const c=s[a];if(Se(c,e),o=o||c.__wasSetVisible||c.__childrenWereVisible,U(c,t)){const d=c.__allChildrenLoaded||c.__hasRenderableContent&&ge(c.__loadingState)||!c.__hasContent&&c.children.length===0||c.__hasUnrenderableContent&&c.__loadingState===B;r=r&&d}}i.__childrenWereVisible=o,i.__allChildrenLoaded=r}}function ve(i,e){const t=e.stats;if(!U(i,e.frameCount))return;const s=e.lruCache;if(i.__isLeaf){i.__loadingState===I?(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++):!s.isFull()&&i.__hasContent&&e.queueTileForDownload(i);return}const n=i.children,o=i.__hasContent,r=ge(i.__loadingState)&&o,a=(e.errorTarget+1)*e.errorThreshold,l=i.__error<=a,c=i.__childrenWereVisible,d=i.__allChildrenLoaded;if((l||i.refine==="ADD")&&!r&&!s.isFull()&&o&&e.queueTileForDownload(i),(l&&!d&&!c&&r||i.refine==="ADD"&&r)&&(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++),i.refine==="REPLACE"&&l&&!d)for(let h=0,f=n.length;h<f;h++){const _=n[h];U(_,e.frameCount)&&ye(_,e)}else for(let h=0,f=n.length;h<f;h++)ve(n[h],e)}function we(i,e){const t=U(i,e.frameCount);if(t||i.__usedLastFrame){let s=!1,n=!1;t?(s=i.__active,e.displayActiveTiles?n=i.__active||i.__visible:n=i.__visible):se(i,e),i.__hasRenderableContent&&i.__loadingState===I&&(i.__wasSetActive!==s&&e.invokeOnePlugin(r=>r.setTileActive&&r.setTileActive(i,s)),i.__wasSetVisible!==n&&e.invokeOnePlugin(r=>r.setTileVisible&&r.setTileVisible(i,n))),i.__wasSetActive=s,i.__wasSetVisible=n,i.__usedLastFrame=t;const o=i.children;for(let r=0,a=o.length;r<a;r++){const l=o[r];we(l,e)}}}function bt(i,e=null){let t=i;for(;t;){const s=t.__depth,n=t.parent;e&&e(t,n,s),t=n}}const ae=Symbol("PLUGIN_REGISTERED"),X=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:i.__inFrustum!==e.__inFrustum?i.__inFrustum?1:-1:i.__used!==e.__used?i.__used?1:-1:i.__error!==e.__error?i.__error>e.__error?1:-1:i.__distanceFromCamera!==e.__distanceFromCamera?i.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,Ke=(i,e)=>i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:i.__loadingState!==e.__loadingState?i.__loadingState>e.__loadingState?-1:1:i.__lastFrameVisited!==e.__lastFrameVisited?i.__lastFrameVisited>e.__lastFrameVisited?-1:1:i.__hasUnrenderableContent!==e.__hasUnrenderableContent?i.__hasUnrenderableContent?-1:1:i.__error!==e.__error?i.__error>e.__error?-1:1:0;class et{get root(){const e=this.rootTileSet;return e?e.root:null}get loadProgress(){const e=this.stats,t=e.downloading+e.parsing,s=e.inCacheSinceLoad;return s===0?1:1-t/s}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=k,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set;const t=new Ye;t.unloadPriorityCallback=Ke;const s=new Y;s.maxJobs=10,s.priorityCallback=X;const n=new Y;n.maxJobs=1,n.priorityCallback=X;const o=new Y;o.maxJobs=25,o.priorityCallback=X,o.log=!0,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.processNodeQueue=o,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(e[ae]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const t=this.plugins,s=e.priority||0;let n=t.length;for(let o=0;o<t.length;o++)if((t[o].priority||0)>s){n=o;break}t.splice(n,0,e),e[ae]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if(typeof e=="string"&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find(t=>t.name===e)||null}traverse(e,t,s=!0){this.root&&Ze(this.root,(n,...o)=>(s&&this.ensureChildrenArePreprocessed(n,!0),e?e(n,...o):!1),t)}queueTileForDownload(e){e.__loadingState===k&&this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}update(){const{lruCache:e,usedSet:t,stats:s,root:n}=this;if(this.rootLoadingState===k&&(this.rootLoadingState=O,this.invokeOnePlugin(r=>r.loadRootTileSet&&r.loadRootTileSet()).then(r=>{this.rootLoadingState=I,this.rootTileSet=r,this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tile-set",tileSet:r})}).catch(r=>{this.rootLoadingState=B,console.error(r),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:r})})),!n)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,t.forEach(r=>e.markUnused(r)),t.clear(),xe(n,this),Se(n,this),ve(n,this),we(n,this);const o=this.queuedTiles;o.sort(e.unloadPriorityCallback);for(let r=0,a=o.length;r<a&&!e.isFull();r++)this.requestTileContents(o[r]);o.length=0,e.scheduleUnload()}resetFailedTiles(){this.rootLoadingState===B&&(this.rootLoadingState=k);const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===B&&(t.__loadingState=k)},null,!1),e.failed=0)}dispose(){this.plugins.forEach(s=>{this.unregisterPlugin(s)});const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1),null,!1);for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}dispatchEvent(e){}fetchData(e,t){return fetch(e,t)}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin(t=>t.setTileVisible&&t.setTileVisible(e,!1)),e.__visible=!1),e.__active&&(this.invokeOnePlugin(t=>t.setTileActive&&t.setTileActive(e,!1)),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],(n=e.content)!=null&&n.uri){const o=re(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=!!(o&&/json$/.test(o)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__childrenProcessed=0,s&&s.__childrenProcessed++,e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=k,s===null?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins(o=>{o!==this&&o.preprocessNode&&o.preprocessNode(e,t,s)})}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateTileViewError(e,t){}ensureChildrenArePreprocessed(e,t=!1){const s=e.children;for(let n=0,o=s.length;n<o;n++){const r=s[n];if("__depth"in r)break;t?(this.processNodeQueue.remove(r),this.preprocessNode(r,e.__basePath,e)):this.processNodeQueue.has(r)||this.processNodeQueue.add(r,a=>{this.preprocessNode(a,e.__basePath,e)})}}preprocessTileSet(e,t,s=null){const n=e.asset.version,[o,r]=n.split(".").map(l=>parseInt(l));console.assert(o<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),o===1&&r>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(e.root,a,s)}loadRootTileSet(){let e=this.rootURL;return this.invokeAllPlugins(s=>e=s.preprocessURL?s.preprocessURL(e,null):e),this.invokeOnePlugin(s=>s.fetchData&&s.fetchData(e,this.fetchOptions)).then(s=>{if(s.ok)return s.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${s.status} : ${s.statusText}`)}).then(s=>(this.preprocessTileSet(s,e),s))}requestTileContents(e){if(e.__loadingState!==k)return;let t=!1,s=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins(h=>s=h.preprocessURL?h.preprocessURL(s,e):s);const n=this.stats,o=this.lruCache,r=this.downloadQueue,a=this.parseQueue,l=re(s),c=new AbortController,d=c.signal;if(o.add(e,h=>{c.abort(),t?(h.children.length=0,h.__childrenProcessed=0):this.invokeAllPlugins(f=>{f.disposeTile&&f.disposeTile(h)}),n.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),n.inCacheSinceLoad--),h.__loadingState===O?n.downloading--:h.__loadingState===H&&n.parsing--,h.__loadingState=k,a.remove(h),r.remove(h)}))return n.parsing===0&&n.downloading===0&&this.dispatchEvent({type:"tiles-load-start"}),this.cachedSinceLoadComplete.add(e),n.inCacheSinceLoad++,n.inCache++,n.downloading++,e.__loadingState=O,r.add(e,h=>d.aborted?Promise.resolve():this.invokeOnePlugin(f=>f.fetchData&&f.fetchData(s,{...this.fetchOptions,signal:d}))).then(h=>{if(!d.aborted){if(h.ok)return l==="json"?h.json():h.arrayBuffer();throw new Error(`Failed to load model with error code ${h.status}`)}}).then(h=>{if(!d.aborted)return n.downloading--,n.parsing++,e.__loadingState=H,a.add(e,f=>d.aborted?Promise.resolve():l==="json"&&h.root?(this.preprocessTileSet(h,s,e),e.children.push(h.root),t=!0,Promise.resolve()):this.invokeOnePlugin(_=>_.parseTile&&_.parseTile(h,f,l,s,d)))}).then(()=>{d.aborted||(n.parsing--,e.__loadingState=I,o.setLoaded(e,!0),o.getMemoryUsage(e)===null&&(o.isFull()&&o.computeMemoryUsageCallback(e)>0?o.remove(e):o.updateMemoryUsage(e)),this.dispatchEvent({type:"load-content"}),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e}))}).catch(h=>{d.aborted||(h.name!=="AbortError"?(a.remove(e),r.remove(e),e.__loadingState===H?n.parsing--:e.__loadingState===O&&n.downloading--,n.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(h),e.__loadingState=B,o.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:h,uri:s})):o.remove(e))}).finally(()=>{n.parsing===0&&n.downloading===0&&(this.cachedSinceLoadComplete.clear(),n.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}))})}getAttributions(e=[]){return this.invokeAllPlugins(t=>t!==this&&t.getAttributions&&t.getAttributions(e)),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const o=e(t[n]);o&&s.push(o)}return s.length===0?null:Promise.all(s)}}const V=new L;class tt extends pe{constructor(e){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e,this.matrixWorldInverse=new L}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?V.copy(this.matrix):V.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=V.elements,s=this.matrixWorld.elements;let n=!1;for(let o=0;o<16;o++){const r=t[o],a=s[o];if(Math.abs(r-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(V),this.matrixWorldInverse.copy(V).invert();const o=this.children;for(let r=0,a=o.length;r<a;r++)o[r].updateMatrixWorld()}}}}const Te=new me,Z=new x,W=[];function Ce(i,e){return i.distance-e.distance}function Pe(i,e,t,s){const{scene:n}=i.cached;t.invokeOnePlugin(r=>r.raycastTile&&r.raycastTile(i,n,e,s))||e.intersectObject(n,!0,s)}function st(i,e,t){Pe(i,e,t,W),W.sort(Ce);const s=W[0]||null;return W.length=0,s}function Me(i){return"__used"in i}function Re(i,e,t,s=null){const{group:n,activeTiles:o}=i;s===null&&(s=Te,s.copy(t.ray).applyMatrix4(n.matrixWorldInverse));const r=[],a=e.children;for(let d=0,p=a.length;d<p;d++){const h=a[d];if(!Me(h)||!h.__used)continue;h.cached.boundingVolume.intersectRay(s,Z)!==null&&(Z.applyMatrix4(n.matrixWorld),r.push({distance:Z.distanceToSquared(t.ray.origin),tile:h}))}r.sort(Ce);let l=null,c=1/0;if(o.has(e)){const d=st(e,t,i);d&&(l=d,c=d.distance*d.distance)}for(let d=0,p=r.length;d<p;d++){const h=r[d],f=h.distance,_=h.tile;if(f>c)break;const b=Re(i,_,t,s);if(b){const m=b.distance*b.distance;m<c&&(l=b,c=m)}}return l}function ke(i,e,t,s,n=null){if(!Me(e))return;const{group:o,activeTiles:r}=i,{boundingVolume:a}=e.cached;if(n===null&&(n=Te,n.copy(t.ray).applyMatrix4(o.matrixWorldInverse)),!e.__used||!a.intersectsRay(n))return;r.has(e)&&Pe(e,t,i,s);const l=e.children;for(let c=0,d=l.length;c<d;c++)ke(i,l[c],t,s,n)}const q=new x,j=new x,S=new x,G=new me;class le{constructor(e=new Ie,t=new L){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new L,this.points=new Array(8).fill().map(()=>new x),this.planes=new Array(6).fill().map(()=>new Oe)}copy(e){return this.box.copy(e.box),this.transform.copy(e.transform),this.update(),this}clone(){return new this.constructor().copy(this)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,S).distanceTo(e)}containsPoint(e){return S.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(S)}intersectsRay(e){return G.copy(e).applyMatrix4(this.inverseTransform),G.intersectsBox(this.box)}intersectRay(e,t){return G.copy(e).applyMatrix4(this.inverseTransform),G.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:o,max:r}=n;let a=0;for(let l=-1;l<=1;l+=2)for(let c=-1;c<=1;c+=2)for(let d=-1;d<=1;d+=2)e[a].set(l<0?o.x:r.x,c<0?o.y:r.y,d<0?o.z:r.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){q.copy(this.box.min).applyMatrix4(this.transform),j.copy(this.box.max).applyMatrix4(this.transform),S.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(S,q),this.planes[1].setFromNormalAndCoplanarPoint(S,j).negate(),S.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(S,q),this.planes[3].setFromNormalAndCoplanarPoint(S,j).negate(),S.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(S,q),this.planes[5].setFromNormalAndCoplanarPoint(S,j).negate()}intersectsSphere(e){return this.clampPoint(e.center,S),S.distanceToSquared(e.center)<=e.radius*e.radius}intersectsFrustum(e){return this._intersectsPlaneShape(e.planes,e.points)}intersectsOBB(e){return this._intersectsPlaneShape(e.planes,e.points)}_intersectsPlaneShape(e,t){const s=this.points,n=this.planes;for(let o=0;o<6;o++){const r=e[o];let a=-1/0;for(let l=0;l<8;l++){const c=s[l],d=r.distanceToPoint(c);a=a<d?d:a}if(a<0)return!1}for(let o=0;o<6;o++){const r=n[o];let a=-1/0;for(let l=0;l<8;l++){const c=t[l],d=r.distanceToPoint(c);a=a<d?d:a}if(a<0)return!1}return!0}}const P=new x,M=new x,R=new x,ce=new x,he=new x;class nt{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let o=-1/0,r=-1/0;s&&e.intersectSphere(s,ce)&&(o=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(ce)),n&&n.intersectRay(e,he)&&(r=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(he));const a=Math.max(o,r);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,o=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(o=s.distanceToPoint(e)),n>o?n:o}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}intersectsSphere(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!s.intersectsSphere(e)||t&&!t.intersectsSphere(e)?!1:!!(s||t)}intersectsOBB(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsOBB(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new le;P.set(e[3],e[4],e[5]),M.set(e[6],e[7],e[8]),R.set(e[9],e[10],e[11]);const n=P.length(),o=M.length(),r=R.length();P.normalize(),M.normalize(),R.normalize(),n===0&&P.crossVectors(M,R),o===0&&M.crossVectors(P,R),r===0&&R.crossVectors(P,M),s.transform.set(P.x,M.x,R.x,e[0],P.y,M.y,R.y,e[1],P.z,M.z,R.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-o,-r),s.box.max.set(n,o,r),s.update(),this.obb=s}setSphereData(e,t,s,n,o){const r=new Ne;r.center.set(e,t,s),r.radius=n,r.applyMatrix4(o),this.sphere=r}setRegionData(e,t,s,n,o,r,a){const l=new Qe(...e.radius,s,o,t,n,r,a),c=new le;l.getBoundingBox(c.box,c.transform),c.update(),this.region=l,this.regionObb=c}}const it=new We;function rt(i,e,t,s){const n=it.set(i.normal.x,i.normal.y,i.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-i.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class ot extends ze{constructor(){super(),this.points=Array(8).fill().map(()=>new x)}setFromProjectionMatrix(e,t){return super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,o)=>{rt(n[0],n[1],n[2],t[o])})}}function at(i){const{TextureUtils:e}=qe;if(!e)return 0;const t=new Set;let s=0;return i.traverse(n=>{if(n.geometry&&!t.has(n.geometry)&&(s+=$e(n.geometry),t.add(n.geometry)),n.material){const o=n.material;for(const r in o){const a=o[r];if(a&&a.isTexture&&!t.has(a)){const{format:l,type:c,image:d}=a,{width:p,height:h}=d,f=e.getByteLength(p,h,l,c);s+=a.generateMipmaps?f*4/3:f,t.add(a)}}}}),s}const de=new L,ue=new Ge,Le=Symbol("INITIAL_FRUSTUM_CULLED"),J=new L,D=new x,K=new _e,Q={inView:!1,error:1/0},lt=new x(1,0,0),ct=new x(0,1,0);function fe(i,e){i.traverse(t=>{t.frustumCulled=t[Le]&&e})}class yt extends et{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{fe(t,!e)}))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(e){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=e}constructor(...e){super(...e),this.group=new tt(this),this.ellipsoid=Ee.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new L,this.lruCache.computeMemoryUsageCallback=s=>s.cached.bytesUsed??null,this._autoDisableRendererCulling=!0;const t=new je;t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,this._listeners={}}addEventListener(...e){N.prototype.addEventListener.call(this,...e)}hasEventListener(...e){N.prototype.hasEventListener.call(this,...e)}removeEventListener(...e){N.prototype.removeEventListener.call(this,...e)}dispatchEvent(...e){N.prototype.dispatchEvent.call(this,...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached&&t.cached.scene;s&&e(s,t)},null,!1)}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Re(this,this.root,e);s&&t.push(s)}else ke(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new _e),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const o=t.isVector2?t.x:t,r=t.isVector2?t.y:s,a=n.get(e);return(a.width!==o||a.height!==r)&&(a.set(o,r),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(K).multiplyScalar(t.getPixelRatio()),this.setResolution(e,K.x,K.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(t=>{const{asset:s,extensions:n={}}=t;switch((s&&s.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(ct,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(lt,Math.PI/2);break}if("3DTILES_ellipsoid"in n){const r=n["3DTILES_ellipsoid"],{ellipsoid:a}=this;a.name=r.body,r.radii?a.radius.set(...r.radii):a.radius.set(1,1,1)}return t})}update(){let e=null;if(this.invokeAllPlugins(r=>{if(r.doTilesNeedUpdate){const a=r.doTilesNeedUpdate();e===null?e=a:e=!!(e||a)}}),e===!1){this.dispatchEvent({type:"update-before"}),this.dispatchEvent({type:"update-after"});return}this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,o=this.cameraInfo;if(s.length===0){let r=!1;if(this.invokeAllPlugins(a=>r=r||!!(a!==this&&a.calculateTileViewError)),r===!1){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}}for(;o.length>s.length;)o.pop();for(;o.length<s.length;)o.push({frustum:new ot,isOrthographic:!1,sseDenominator:-1,position:new x,invScale:-1,pixelSize:0});D.setFromMatrixScale(t.matrixWorldInverse),Math.abs(Math.max(D.x-D.y,D.x-D.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let r=0,a=o.length;r<a;r++){const l=s[r],c=o[r],d=c.frustum,p=c.position,h=n.get(l);(h.width===0||h.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const f=l.projectionMatrix.elements;if(c.isOrthographic=f[15]===1,c.isOrthographic){const _=2/f[0],b=2/f[5];c.pixelSize=Math.max(b/h.height,_/h.width)}else c.sseDenominator=2/f[5]/h.height;J.copy(t.matrixWorld),J.premultiply(l.matrixWorldInverse),J.premultiply(l.projectionMatrix),d.setFromProjectionMatrix(J),p.set(0,0,0),p.applyMatrix4(l.matrixWorld),p.applyMatrix4(t.matrixWorldInverse)}super.update(),this.dispatchEvent({type:"update-after"})}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new L;if(e.transform){const a=e.transform;for(let l=0;l<16;l++)n.elements[l]=a[l]}s&&n.premultiply(s.cached.transform);const o=new L().copy(n).invert(),r=new nt;"sphere"in e.boundingVolume&&r.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&r.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&r.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:o,active:!1,boundingVolume:r,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(e,t,s,n,o){const r=t.cached,a=n.split(/[\\/]/g);a.pop();const l=a.join("/"),c=this.fetchOptions,d=this.manager;let p=null;const h=r.transform,f=this._upRotationMatrix,_=(Je(e)||s).toLowerCase();switch(_){case"b3dm":{const u=new Be(d);u.workingPath=l,u.fetchOptions=c,u.adjustmentTransform.copy(f),p=u.parse(e);break}case"pnts":{const u=new Ve(d);u.workingPath=l,u.fetchOptions=c,p=u.parse(e);break}case"i3dm":{const u=new Ae(d);u.workingPath=l,u.fetchOptions=c,u.adjustmentTransform.copy(f),u.ellipsoid.copy(this.ellipsoid),p=u.parse(e);break}case"cmpt":{const u=new De(d);u.workingPath=l,u.fetchOptions=c,u.adjustmentTransform.copy(f),u.ellipsoid.copy(this.ellipsoid),p=u.parse(e).then(v=>v.scene);break}case"gltf":case"glb":{const u=d.getHandler("path.gltf")||d.getHandler("path.glb")||new He(d);u.setWithCredentials(c.credentials==="include"),u.setRequestHeader(c.headers||{}),c.credentials==="include"&&c.mode==="cors"&&u.setCrossOrigin("use-credentials");let v=u.resourcePath||u.path||l;!/[\\/]$/.test(v)&&v.length&&(v+="/"),p=u.parseAsync(e,v).then(w=>{w.scene=w.scene||new pe;const{scene:g}=w;return g.updateMatrix(),g.matrix.multiply(f).decompose(g.position,g.quaternion,g.scale),w});break}default:{p=this.invokeOnePlugin(u=>u.parseToMesh&&u.parseToMesh(e,t,s,n,o));break}}const b=await p;if(b===null)throw new Error(`TilesRenderer: Content type "${_}" not supported.`);let m,T;b.isObject3D?(m=b,T=null):(m=b.scene,T=b),await this.invokeAllPlugins(u=>u.processTileModel&&u.processTileModel(m,t)),m.updateMatrix(),m.matrix.premultiply(h),m.matrix.decompose(m.position,m.quaternion,m.scale),m.traverse(u=>{u[Le]=u.frustumCulled}),fe(m,!this.autoDisableRendererCulling);const F=[],$=[],A=[];if(m.traverse(u=>{if(u.geometry&&$.push(u.geometry),u.material){const v=u.material;F.push(u.material);for(const w in v){const g=v[w];g&&g.isTexture&&A.push(g)}}}),o.aborted){for(let u=0,v=A.length;u<v;u++){const w=A[u];w.image instanceof ImageBitmap&&w.image.close(),w.dispose()}return}r.materials=F,r.geometry=$,r.textures=A,r.scene=m,r.metadata=T,r.bytesUsed=at(m)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,o=t.textures,r=t.scene.parent;t.scene.traverse(a=>{a.userData.meshFeatures&&a.userData.meshFeatures.dispose(),a.userData.structuralMetadata&&a.userData.structuralMetadata.dispose()});for(let a=0,l=n.length;a<l;a++)n[a].dispose();for(let a=0,l=s.length;a<l;a++)s[a].dispose();for(let a=0,l=o.length;a<l;a++){const c=o[a];c.image instanceof ImageBitmap&&c.image.close(),c.dispose()}r&&r.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const s=e.cached.scene,n=this.group;t?s&&(n.add(s),s.updateMatrixWorld(!0)):s&&n.remove(s),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}calculateTileViewError(e,t){const s=e.cached,n=this.cameras,o=this.cameraInfo,r=s.boundingVolume;let a=!1,l=-1/0,c=1/0,d=-1/0,p=1/0;for(let h=0,f=n.length;h<f;h++){const _=o[h];let b,m;if(_.isOrthographic){const F=_.pixelSize;b=e.geometricError/F,m=1/0}else{const F=_.sseDenominator;m=r.distanceToPoint(_.position),b=e.geometricError/(m*F)}const T=o[h].frustum;r.intersectsFrustum(T)&&(a=!0,l=Math.max(l,b),c=Math.min(c,m)),d=Math.max(d,b),p=Math.min(p,m)}this.invokeAllPlugins(h=>{h!==this&&h.calculateTileViewError&&(h.calculateTileViewError(e,Q),Q.inView&&(a=!0,l=Math.max(l,Q.error)),d=Math.max(d,Q.error))}),a?(t.inView=!0,t.error=l,t.distanceToCamera=c):(t.inView=!1,t.error=d,t.distanceToCamera=p)}setLatLonToYUp(e,t){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:s,group:n}=this;ue.set(Math.PI/2,Math.PI/2,0),de.makeRotationFromEuler(ue),s.getEastNorthUpFrame(e,t,n.matrix).multiply(de).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}export{Ye as L,le as O,Y as P,yt as T,bt as a,Ze as t};
