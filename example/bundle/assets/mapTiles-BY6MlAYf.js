import{i as s,ag as $,d as tt,l as H,V as et,W as it,S as rt,a as ot}from"./three.module-e-akeimH.js";/* empty css               */import{g as at}from"./lil-gui.module.min-Vka56b52.js";import{T as nt}from"./TilesRenderer-C3SKmAML.js";import{T as st}from"./TilesFadePlugin-Bg3AWZ7_.js";import{U as ct}from"./UpdateOnChangePlugin-B00hu5lt.js";import{I as lt,U as Z}from"./ImageFormatPlugin-BKz4sy5s.js";import{E as mt}from"./EnvironmentControls-BRJ_vGuv.js";import{G as ht}from"./GlobeControls-Cuf62xaE.js";import"./I3DMLoader-BvoAYWAX.js";import"./readMagicBytes-CUUeQGnc.js";import"./GLTFLoader-uVyzW9cX.js";import"./Ellipsoid-Ctcbk2JV.js";import"./B3DMLoader-BmDNS6RO.js";import"./PNTSLoader-DzQ3_PKf.js";import"./CMPTLoader-Bq-8QR4v.js";import"./EllipsoidRegion-DVvlgLqj.js";const X=new H,Y=new H,C=new et,B=new tt,O=new H,G=new H;class pt extends lt{constructor(t={}){const{shape:e="planar",endCaps:n=!0,...a}=t;super(a),this.shape=e,this.projection="geodetic",this.endCaps=n,this.minLat=-Math.PI/2,this.maxLat=Math.PI/2,this.minLon=-Math.PI,this.maxLon=Math.PI}async parseToMesh(t,e,...n){const{shape:a,projection:i,tiles:u}=this,m=await super.parseToMesh(t,e,...n);if(a==="ellipsoid"){const E=u.ellipsoid,[A,S,b,V]=e[Z],[w,I,N,U]=e.boundingVolume.region,j=30,g=15,P=Math.ceil((U-I)*s.RAD2DEG*.25),y=Math.ceil((N-w)*s.RAD2DEG*.25),L=Math.max(g,P),z=Math.max(j,y),x=new $(1,1,z,L),{position:T,normal:D,uv:R}=x.attributes,F=T.count;e.cached.boundingVolume.getSphere(B);for(let h=0;h<F;h++){X.fromBufferAttribute(T,h),Y.fromBufferAttribute(D,h),C.fromBufferAttribute(R,h);const M=s.mapLinear(C.x,0,1,w,N);let p=s.mapLinear(C.y,0,1,I,U);if(i==="mercator"&&C.y!==0&&C.y!==1){const l=this.mercatorToLatitude(1),v=1/L,Q=s.mapLinear(C.y-v,0,1,I,U),K=s.mapLinear(C.y+v,0,1,I,U);p>l&&Q<l&&(p=l),p<-l&&K>-l&&(p=-l)}if(E.getCartographicToPosition(p,M,0,X).sub(B.center),E.getCartographicToNormal(p,M,Y),T.setXYZ(h,...X),D.setXYZ(h,...Y),i==="mercator"){const l=s.mapLinear(this.longitudeToMercator(M),A,b,0,1),v=s.mapLinear(this.latitudeToMercator(p),S,V,0,1);R.setXY(h,l,v)}}m.geometry=x,m.position.copy(B.center)}return m}preprocessNode(t,...e){super.preprocessNode(t,e);const{shape:n,projection:a,tileWidth:i,tileHeight:u,width:m,height:E,endCaps:A}=this;if(n==="ellipsoid"){const[S,b,V,w]=t[Z],I=(V-S)/i,N=(w-b)/u,U=1/m,j=1/E;let g,P,y,L;if(a==="mercator")g=this.mercatorToLatitude(b),P=this.mercatorToLatitude(w),y=this.mercatorToLongitude(S),L=this.mercatorToLongitude(V),A&&(w===1&&(P=Math.PI/2),b===0&&(g=-Math.PI/2));else{const{minLat:M,maxLat:p,minLon:l,maxLon:v}=this;g=s.lerp(M,p,b),P=s.lerp(M,p,w),y=s.lerp(l,v,S),L=s.lerp(l,v,V)}t.boundingVolume.region=[y,g,L,P,-1,1];const z=g>0!=P>0?0:Math.min(Math.abs(g),Math.abs(P));let x,T;if(a==="mercator"){const M=this.latitudeToMercator(z);[x,T]=this.getMercatorToCartographicDerivative(S,M)}else x=Math.PI,T=2*Math.PI;const[D,R]=this.getCartographicToMeterDerivative(z,L),F=Math.max(I*T*D,N*x*R),h=Math.max(U*T*D,j*x*R);t.geometricError=F-h,delete t.boundingVolume.box,t.parent===null&&(t.geometricError=1e50)}return t}latitudeToMercator(t){const e=Math.log(Math.tan(Math.PI/4+t/2));return 1/2+1*e/(2*Math.PI)}longitudeToMercator(t){return(t+Math.PI)/(2*Math.PI)}mercatorToLatitude(t){const e=s.mapLinear(t,0,1,-1,1);return 2*Math.atan(Math.exp(e*Math.PI))-Math.PI/2}mercatorToLongitude(t){const{minLon:e,maxLon:n}=this;return s.mapLinear(t,0,1,e,n)}getMercatorToCartographicDerivative(t,e){let a=t-1e-5,i=e-1e-5;return a<0&&(a=t+1e-5),i<0&&(i=e+1e-5),[Math.abs(this.mercatorToLatitude(e)-this.mercatorToLatitude(i))/1e-5,Math.abs(this.mercatorToLongitude(t)-this.mercatorToLongitude(a))/1e-5]}getCartographicToMeterDerivative(t,e){const{tiles:n}=this,{ellipsoid:a}=n,i=1e-5,u=e+i;let m=t+i;Math.abs(m)>Math.PI/2&&(m=m-i),a.getCartographicToPosition(t,e,0,O),a.getCartographicToPosition(m,e,0,G);const E=O.distanceTo(G)/i;return a.getCartographicToPosition(t,u,0,G),[O.distanceTo(G)/i,E]}}class dt extends pt{constructor(t={}){const{levels:e=20,tileDimension:n=256,pixelSize:a=1e-5,...i}=t;super({pixelSize:a,...i}),this.name="XYZ_TILES_PLUGIN",this.tileWidth=n,this.tileHeight=n,this.levels=e,this.url=null,this.flipY=!0}async loadRootTileSet(){const{tiles:t,tileWidth:e,tileHeight:n,maxLevel:a}=this;let i=t.rootURL;return t.invokeAllPlugins(u=>i=u.preprocessURL?u.preprocessURL(i,null):i),this.width=e*2**a,this.height=n*2**a,this.url=i,this.projection="mercator",this.getTileset(i)}getUrl(t,e,n){return this.url.replace("{z}",t).replace("{x}",e).replace("{y}",n)}}let r,W,d,o,c;const _={errorTarget:window.devicePixelRatio,planar:!1};ut();J();function ut(){d=new it({antialias:!0}),d.setPixelRatio(window.devicePixelRatio),d.setSize(window.innerWidth,window.innerHeight),d.setClearColor(1118481),document.body.appendChild(d.domElement),W=new rt,c=new ot(60,window.innerWidth/window.innerHeight,.001,1e4),q(),k(),window.addEventListener("resize",k,!1);const f=new at;f.add(_,"planar").onChange(q),f.add(_,"errorTarget",1,40).onChange(()=>{o.getPluginByName("UPDATE_ON_CHANGE_PLUGIN").needsUpdate=!0}),f.open()}function q(){o&&o.dispose(),r&&r.dispose(),o=new nt("https://tile.openstreetmap.org/{z}/{x}/{y}.png"),o.registerPlugin(new st({maximumFadeOutTiles:200})),o.registerPlugin(new ct),o.registerPlugin(new dt({center:!0,shape:_.planar?"planar":"ellipsoid"})),o.lruCache.minSize=900,o.lruCache.maxSize=1300,o.parseQueue.maxJobs=3,o.setCamera(c),W.add(o.group),_.planar?(o.errorTarget=1,r=new mt(W,c,d.domElement),r.setTilesRenderer(o),r.enableDamping=!0,r.minZoomDistance=2,r.minDistance=.01,r.maxDistance=5e3,r.cameraRadius=0,r.fallbackPlane.normal.set(0,0,1),r.up.set(0,0,1),r.camera.position.set(0,0,2e3),r.camera.quaternion.identity(),c.near=.001,c.far=1e4,c.updateProjectionMatrix()):(o.group.rotation.x=-Math.PI/2,r=new ht(W,c,d.domElement),r.setTilesRenderer(o),r.enableDamping=!0,r.camera.position.set(0,0,1.75*1e7),r.camera.quaternion.identity(),r.minDistance=150)}function k(){const f=window.innerWidth/window.innerHeight;c.aspect=f,c.updateProjectionMatrix(),d.setSize(window.innerWidth,window.innerHeight)}function J(){requestAnimationFrame(J),r.update(),c.updateMatrixWorld(),o.errorTarget=_.errorTarget,o.setCamera(c),o.setResolutionFromRenderer(c,d),o.update(),d.render(W,c)}
