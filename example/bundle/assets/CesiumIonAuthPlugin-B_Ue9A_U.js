import{t as l}from"./TilesRenderer-C3SKmAML.js";class u{constructor(){this.creditsCount={}}_adjustAttributions(t,s){const e=this.creditsCount,i=t.split(/;/g);for(let o=0,h=i.length;o<h;o++){const n=i[o];n in e||(e[n]=0),e[n]+=s?1:-1,e[n]<=0&&delete e[n]}}addAttributions(t){this._adjustAttributions(t,!0)}removeAttributions(t){this._adjustAttributions(t,!1)}toString(){return Object.entries(this.creditsCount).sort((s,e)=>{const i=s[1];return e[1]-i}).map(s=>s[0]).join("; ")}}function a(r){let t=null;return l(r,s=>{if(s.content&&s.content.uri){const[,e]=s.content.uri.split("?");return t=new URLSearchParams(e).get("session"),!0}return!1}),t}class c{constructor({apiToken:t,autoRefreshToken:s=!1,logoUrl:e=null,useRecommendedSettings:i=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=t,this.autoRefreshToken=s,this.useRecommendedSettings=i,this.logoUrl=e,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null,this._tokenRefreshPromise=null,this._attributionsManager=new u,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(t){t!=null&&(t.resetFailedTiles(),t.rootURL==null&&(t.rootURL="https://tile.googleapis.com/v1/3dtiles/root.json"),this.useRecommendedSettings&&(t.parseQueue.maxJobs=10,t.downloadQueue.maxJobs=30,t.errorTarget=40),this.tiles=t,this._onLoadCallback=({tileSet:s})=>{this.sessionToken=a(s.root),t.removeEventListener("load-tile-set",this._onLoadCallback)},this._visibilityChangeCallback=({tile:s,visible:e})=>{const i=s.cached.metadata.asset.copyright||"";e?this._attributionsManager.addAttributions(i):this._attributionsManager.removeAttributions(i)},t.addEventListener("load-tile-set",this._onLoadCallback),t.addEventListener("tile-visibility-change",this._visibilityChangeCallback))}getAttributions(t){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,t.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),t.push(this._attribution))}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&(t.searchParams.append("key",this.apiToken),this.sessionToken!==null&&t.searchParams.append("session",this.sessionToken)),t.toString()}dispose(){const{tiles:t}=this;t.removeEventListener("load-tile-set",this._onLoadCallback),t.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(t,s){this._tokenRefreshPromise!==null&&(await this._tokenRefreshPromise,t=this.preprocessURL(t));const e=await fetch(t,s);return e.status>=400&&e.status<=499&&this.autoRefreshToken?(await this._refreshToken(s),fetch(this.preprocessURL(t),s)):e}_refreshToken(t){if(this._tokenRefreshPromise===null){const s=new URL(this.tiles.rootURL);s.searchParams.append("key",this.apiToken),this._tokenRefreshPromise=fetch(s,t).then(e=>e.json()).then(e=>{this.sessionToken=a(e.root),this._tokenRefreshPromise=null}),this._tokenRefreshPromise.catch(e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,rootURL:s})})}return this._tokenRefreshPromise}}class d{constructor({apiToken:t,assetId:s=null,autoRefreshToken:e=!1}){this.name="CESIUM_ION_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=t,this.assetId=s,this.autoRefreshToken=e,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[],this._disposed=!1}init(t){this.assetId!==null&&(t.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=t,this.endpointURL=t.rootURL,t.resetFailedTiles()}loadRootTileSet(){return this._refreshToken().then(()=>this.tiles.invokeOnePlugin(t=>t!==this&&t.loadRootTileSet&&t.loadRootTileSet()))}preprocessURL(t){return t=new URL(t),/^http/.test(t.protocol)&&this._tileSetVersion!=-1&&t.searchParams.append("v",this._tileSetVersion),t.toString()}fetchData(t,s){return this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")!==null?null:Promise.resolve().then(async()=>{this._tokenRefreshPromise!==null&&(await this._tokenRefreshPromise,t=this.preprocessURL(t));const i=await fetch(t,s);return i.status>=400&&i.status<=499&&this.autoRefreshToken?(await this._refreshToken(s),fetch(this.preprocessURL(t),s)):i})}getAttributions(t){this.tiles.visibleTiles.size>0&&t.push(...this._attributions)}_refreshToken(t){if(this._tokenRefreshPromise===null){const s=new URL(this.endpointURL);s.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(s,t).then(e=>{if(this._disposed)return null;if(!e.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${e.status}`);return e.json()}).then(e=>{if(this._disposed)return null;const i=this.tiles;if("externalType"in e){const o=new URL(e.options.url);i.rootURL=e.options.url,i.registerPlugin(new c({apiToken:o.searchParams.get("key"),autoRefreshToken:this.autoRefreshToken}))}else{if(i.rootURL=e.url,i.fetchOptions.headers=i.fetchOptions.headers||{},i.fetchOptions.headers.Authorization=`Bearer ${e.accessToken}`,s.searchParams.has("v")&&this._tileSetVersion===-1){const o=new URL(e.url);this._tileSetVersion=o.searchParams.get("v")}this._bearerToken=e.accessToken,e.attributions&&(this._attributions=e.attributions.map(o=>({value:o.html,type:"html",collapsible:o.collapsible})))}return this._tokenRefreshPromise=null,e}),this._tokenRefreshPromise.catch(e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,url:s})})}return this._tokenRefreshPromise}dispose(){this._disposed=!0}}export{d as C};
